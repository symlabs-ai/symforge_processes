{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://forgeprocess.dev/schemas/estimates.schema.json",
  "title": "ForgeProcess Estimates Schema",
  "description": "Schema para validar estimates.yml com modelo de tres dimensoes (Custo, Esforco, Prazo)",
  "type": "object",
  "required": ["version", "project", "configuracao", "features", "totals"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+$",
      "description": "Versao do schema (ex: 2.0)"
    },
    "project": {
      "type": "string",
      "minLength": 1,
      "description": "Nome do projeto"
    },
    "date": {
      "type": "string",
      "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$",
      "description": "Data no formato AAAA-MM-DD"
    },
    "configuracao": {
      "$ref": "#/definitions/configuracao"
    },
    "features": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/feature"
      },
      "minItems": 1
    },
    "totals": {
      "$ref": "#/definitions/totals"
    },
    "notas": {
      "type": "string",
      "description": "Notas e referencias adicionais"
    }
  },
  "definitions": {
    "configuracao": {
      "type": "object",
      "required": ["modelo_ia", "custo_por_1k_tokens_output", "valor_hora_humano"],
      "properties": {
        "modelo_ia": {
          "type": "string",
          "description": "Modelo de IA utilizado (ex: claude-sonnet-4-20250514)"
        },
        "custo_por_1k_tokens_input": {
          "type": "number",
          "minimum": 0,
          "description": "Custo por 1k tokens de input em USD"
        },
        "custo_por_1k_tokens_output": {
          "type": "number",
          "minimum": 0,
          "description": "Custo por 1k tokens de output em USD"
        },
        "valor_hora_humano": {
          "type": "number",
          "minimum": 0,
          "description": "Valor da hora humana em USD"
        },
        "agentes_paralelos": {
          "type": "integer",
          "minimum": 1,
          "default": 1,
          "description": "Quantidade de agentes trabalhando em paralelo"
        },
        "reducao_prazo_paralelizacao": {
          "type": "integer",
          "minimum": 0,
          "maximum": 60,
          "default": 30,
          "description": "Percentual de reducao no prazo com paralelizacao"
        }
      }
    },
    "range_minmax": {
      "type": "object",
      "required": ["min", "max"],
      "properties": {
        "min": {
          "type": "number",
          "minimum": 0,
          "description": "Valor minimo do range"
        },
        "max": {
          "type": "number",
          "minimum": 0,
          "description": "Valor maximo do range"
        }
      },
      "additionalProperties": false
    },
    "custo": {
      "type": "object",
      "required": ["tokens_estimados", "horas_humanas", "custo_total_usd"],
      "properties": {
        "tokens_estimados": {
          "type": "integer",
          "minimum": 0,
          "description": "Tokens estimados (input + output)"
        },
        "custo_ia_usd": {
          "type": "number",
          "minimum": 0,
          "description": "Custo de IA em USD"
        },
        "horas_humanas": {
          "type": "number",
          "minimum": 0,
          "description": "Horas humanas estimadas"
        },
        "custo_humano_usd": {
          "type": "number",
          "minimum": 0,
          "description": "Custo humano em USD"
        },
        "custo_total_usd": {
          "type": "number",
          "minimum": 0,
          "description": "Custo total em USD (IA + humano)"
        }
      }
    },
    "esforco": {
      "type": "object",
      "required": ["tokens", "horas"],
      "properties": {
        "tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Tokens totais de esforco IA"
        },
        "tokens_breakdown": {
          "type": "object",
          "properties": {
            "bdd_specs": {
              "type": "integer",
              "minimum": 0
            },
            "tdd_tests": {
              "type": "integer",
              "minimum": 0
            },
            "implementation": {
              "type": "integer",
              "minimum": 0
            },
            "review_ajustes": {
              "type": "integer",
              "minimum": 0
            }
          },
          "description": "Detalhamento de tokens por atividade"
        },
        "horas": {
          "type": "number",
          "minimum": 0,
          "description": "Horas humanas totais"
        },
        "horas_breakdown": {
          "type": "object",
          "properties": {
            "review": {
              "type": "number",
              "minimum": 0
            },
            "testes": {
              "type": "number",
              "minimum": 0
            },
            "arquitetura": {
              "type": "number",
              "minimum": 0
            },
            "merge_deploy": {
              "type": "number",
              "minimum": 0
            }
          },
          "description": "Detalhamento de horas por atividade"
        }
      }
    },
    "prazo": {
      "type": "object",
      "required": ["tempo_ciclo_dias"],
      "properties": {
        "tempo_ciclo_dias": {
          "$ref": "#/definitions/range_minmax",
          "description": "Tempo de ciclo em dias (SEMPRE range min/max)"
        },
        "com_paralelizacao": {
          "$ref": "#/definitions/range_minmax",
          "description": "Tempo de ciclo com paralelizacao aplicada"
        },
        "data_alvo": {
          "type": ["string", "null"],
          "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$",
          "description": "Data alvo (opcional, preenchido durante planejamento)"
        }
      }
    },
    "task": {
      "type": "object",
      "required": ["id", "name", "custo", "prazo"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^TASK-[0-9]+$",
          "description": "ID da tarefa (ex: TASK-001)"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Nome da tarefa"
        },
        "custo": {
          "type": "object",
          "properties": {
            "tokens_estimados": {
              "type": "integer",
              "minimum": 0
            },
            "horas_humanas": {
              "type": "number",
              "minimum": 0
            },
            "custo_total_usd": {
              "type": "number",
              "minimum": 0
            }
          }
        },
        "prazo": {
          "type": "object",
          "properties": {
            "tempo_ciclo_dias": {
              "$ref": "#/definitions/range_minmax"
            }
          }
        }
      }
    },
    "feature": {
      "type": "object",
      "required": ["id", "name", "effort_tshirt", "custo", "esforco", "prazo"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9_]+\\.feature$",
          "description": "ID da feature (ex: checkout.feature)"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Nome descritivo da feature"
        },
        "track": {
          "type": "string",
          "description": "ID do ValueTrack/SupportTrack associado"
        },
        "effort_tshirt": {
          "type": "string",
          "enum": ["XS", "S", "M", "L", "XL"],
          "description": "Tamanho T-shirt da feature"
        },
        "custo": {
          "$ref": "#/definitions/custo"
        },
        "esforco": {
          "$ref": "#/definitions/esforco"
        },
        "prazo": {
          "$ref": "#/definitions/prazo"
        },
        "risk": {
          "type": "string",
          "enum": ["LOW", "MEDIUM", "HIGH"],
          "default": "MEDIUM",
          "description": "Nivel de risco"
        },
        "dependencies": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "IDs de features que devem ser concluidas antes"
        },
        "sprint": {
          "type": "integer",
          "minimum": 1,
          "description": "Sprint em que a feature sera desenvolvida"
        },
        "priority": {
          "type": "string",
          "enum": ["P0", "P1", "P2", "P3"],
          "description": "Prioridade (P0 = critico)"
        },
        "tasks": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/task"
          },
          "description": "Lista de tarefas (para features XL quebradas)"
        }
      }
    },
    "totals": {
      "type": "object",
      "required": ["total_features", "custo", "esforco", "prazo"],
      "properties": {
        "total_features": {
          "type": "integer",
          "minimum": 0,
          "description": "Numero total de features"
        },
        "custo": {
          "type": "object",
          "required": ["tokens_totais", "custo_total_usd"],
          "properties": {
            "tokens_totais": {
              "type": "integer",
              "minimum": 0
            },
            "custo_ia_usd": {
              "type": "number",
              "minimum": 0
            },
            "horas_totais": {
              "type": "number",
              "minimum": 0
            },
            "custo_humano_usd": {
              "type": "number",
              "minimum": 0
            },
            "custo_total_usd": {
              "type": "number",
              "minimum": 0
            }
          }
        },
        "esforco": {
          "type": "object",
          "required": ["tokens", "horas"],
          "properties": {
            "tokens": {
              "type": "integer",
              "minimum": 0
            },
            "horas": {
              "type": "number",
              "minimum": 0
            },
            "horas_breakdown": {
              "type": "object",
              "properties": {
                "review": {
                  "type": "number",
                  "minimum": 0
                },
                "testes": {
                  "type": "number",
                  "minimum": 0
                },
                "arquitetura": {
                  "type": "number",
                  "minimum": 0
                },
                "merge_deploy": {
                  "type": "number",
                  "minimum": 0
                }
              }
            }
          }
        },
        "prazo": {
          "type": "object",
          "required": ["tempo_ciclo_total"],
          "properties": {
            "tempo_ciclo_total": {
              "$ref": "#/definitions/range_minmax"
            },
            "com_paralelizacao": {
              "$ref": "#/definitions/range_minmax"
            },
            "sprints": {
              "type": "integer",
              "minimum": 1
            }
          }
        },
        "by_sprint": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "features": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "custo": {
                "type": "object"
              },
              "esforco": {
                "type": "object"
              },
              "prazo": {
                "type": "object"
              }
            }
          },
          "description": "Metricas agrupadas por sprint"
        },
        "by_cycle": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "valuetracks": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "custo": {
                "type": "object"
              },
              "esforco": {
                "type": "object"
              },
              "prazo": {
                "type": "object"
              }
            }
          },
          "description": "Metricas agrupadas por ciclo"
        }
      }
    }
  }
}
